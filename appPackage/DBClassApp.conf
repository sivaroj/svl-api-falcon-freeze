[Ora]
user: svlreader
pass: svlreader
service: TRANS
server: 192.168.0.2
port: 1521
[Postgresql]
server: 192.168.0.104
port: 5432
database: transport
[PostgresqlV12]
server: 192.168.0.191
port: 5432
database: transport
[Query]
qrySumLh_dn: select
    to_char( sum(l.wgt),'99999D999' ) as total_weight
    , to_char(count(distinct l.car_regis_no),'9999' ) as total_trucks
    , to_char(count(l.coil_no),'9999' ) as total_coils
    , to_char(count(distinct l.receiver),'9999') as total_receiver
    , to_char(count(distinct l.dn_no),'9999') as total_dn
    from lh_dn l
    {{inner_join_sub}}
    where l.dn_date = to_date(%(dn_date)s,'dd/mm/yyyy') and l.status='A'
    {{factory}}
#------------------------------------------------------------------------------------------
qrySumSubLh_dn: select
    to_char( sum(l.wgt),'99999D999' ) as total_weight
    , to_char(count(distinct l.car_regis_no),'9999' ) as total_trucks
    , to_char(count(l.coil_no),'9999' ) as total_coils
    , to_char(count(distinct l.receiver),'9999') as total_receiver
    , to_char(count(distinct l.dn_no),'9999') as total_dn
    from lh_dn l
    {{inner_join_sub}}
	where l.dn_date = to_date(%(dn_date)s,'dd/mm/yyyy')
    {{factory}}
#------------------------------------------------------------------------------------------
qrySumSubProduct: select x.product,
	   to_char(x.weight,'99999D999') as weight,
	   to_char(round(x.weight / sum(x.weight) over() * 100,2),'999D99') as pct,
	   x.trucks
    from (
        select l.product,sum(l.wgt) as weight,count(distinct l.car_regis_no)  as trucks
        from lh_dn l
        {{inner_join_sub}}
        where l.dn_date = to_date(%(dn_date)s,'dd/mm/yyyy') and l.status='A'
        {{factory}}
        group by l.product
    ) x
#------------------------------------------------------------------------------------------
qrySumProduct: select x.product, to_char(x.weight,'99999D999') as weight, to_char(round(x.weight / sum(x.weight) over() * 100,2),'999D99') as pct
    , x.trucks
    from (
        select l.product,sum(l.wgt) as weight,count(distinct l.car_regis_no)  as trucks
        from lh_dn l
        {{inner_join_sub}}
        where l.dn_date = to_date(%(dn_date)s,'dd/mm/yyyy') and l.status='A'
        {{factory}}
        group by l.product
    ) x
#------------------------------------------------------------------------------------------
qrySumFactoryProduct: select x.customer_no
    ,(case when x.product is null then 'Total' else x.product end ) as product
    ,to_char(x.weight,'99999D999') as weight
    ,to_char(round(x.weight / sum(x.weight) over() * 100,2),'999D99') as pct
    ,case when x.product is not null then coalesce(x.trucks||'') else '' end as truck
    ,COALESCE((select c.coil_remain||'' from coil_remain c where c.customer_no=x.customer_no and c.dn_date= to_date( %(dn_date)s, 'dd/mm/yyyy') and c.product = x.product),'0') as coil_remain
    ,(case when (select 1 from associated_comp where company=x.customer_no and logistics='LH' limit 1) = 1 then 'true' else 'false' end ) as associated
    from (
    with t as (
        select l.customer_no,l.product,count(distinct l.car_regis_no)  as trucks,sum(l.wgt) as weight
        from lh_dn l
        {{inner_join_sub}}
        where l.dn_date = to_date( %(dn_date)s, 'dd/mm/yyyy') and l.status='A'
        {{factory}}
        group by rollup (l.customer_no,l.product)
    )
    select *
    from t as t1
    where ( 2 = (select count(*) from t as t2 where t1.customer_no = t2.customer_no) and t1.product is not null)
    or ( 2 < (select count(*) from t as t2 where t1.customer_no = t2.customer_no) )
    ) x
#------------------------------------------------------------------------------------------
qryDnTrucks: select l.customer_no,l.car_regis_no,l.truck_no
    ,to_char(sum(CASE WHEN (l.status='A') THEN 1     ELSE 0 END),'999') AS coils
    ,to_char(sum(CASE WHEN (l.status='A') THEN l.wgt   ELSE 0 END),'999.99') AS  wgt
    ,to_char(SUM(distinct CASE WHEN (l.status='D') THEN 1     ELSE 0 END),'9') AS haveCancel
    from lh_dn l
    {{inner_join_sub}}
	where l.dn_date = to_date( %(dn_date)s , 'dd/mm/yyyy')
    {{factory}}
    group by l.customer_no,l.car_regis_no,l.truck_no;
#------------------------------------------------------------------------------------------
qryCoilsOnTruck: SELECT
    array_to_json(array_agg(t))
    from
    (
        select l.emp_no,l.driver,l.tel
        ,(CASE WHEN (l.status='D') THEN '*** ยกเลิก DN ***'     ELSE l.receiver END) as receiver
        ,l.status,count(distinct l.coil_no) as coils,sum(l.wgt) as weight
        ,json_agg(
            row_to_json(
   	            ( select CoilDetail from (select l.dn_no,l.product,l.coil_no,l.cus_job_no,l.cus,l.thk,l.wid,l.wgt) as CoilDetail (dn_no,product,coil_no,cus_job_no,cus,thk,wid,wgt) )
            )
        ) as CoilDetail
    from lh_dn l where l.dn_date = to_date( %(dn_date)s , 'dd/mm/yyyy') and l.customer_no = %(company)s and l.car_regis_no = %(car_regis_no)s
    group by l.receiver,l.status,l.emp_no,l.driver,l.tel
    )t;
#------------------------------------------------------------------------------------------
qryGetCusOrder: select
    l.cus,l.receiver,count(distinct l.car_regis_no) as truck,to_char(sum(l.wgt),'9990.999') as wgt
    ,l.customer_no
    from lh_dn l
    inner join line_lh_car_regis lg on lg.car_regis = l.car_regis_no and lg.status='N'
    {{inner_join_sub}}
    where l.dn_date= to_date(%(dn_date)s,'dd/mm/yyyy') and l.status='A'
    {{factory}}
    group by l.cus,l.receiver,l.customer_no;
#------------------------------------------------------------------------------------------
qryGetCusOrderDtl: with t as
    (
         select  l.car_regis_no,l.driver,l.tel,count(distinct l.coil_no) as coils,sum(l.wgt) as weight,l.cus
         ,l.receiver ,lg.customer_no as supplier
         ,json_agg(
                    row_to_json(
                        ( select CoilDetail from (select l.product,l.coil_no,l.thk,l.wid,l.wgt) as CoilDetail
                        (product,coil_no,thk,wid,wgt) )
                    )
                ) as CoilDetail
         from lh_dn l
             inner join line_lh_car_regis lg on lg.car_regis = l.car_regis_no and lg.status='N'
             {{inner_join_sub}}
              where l.dn_date = to_date(%(dn_date)s,'dd/mm/yyyy')
              {{factory}}
              {{cus}}
              and l.receiver = %(receiver)s
              and l.status='A'
          group by l.car_regis_no,l.driver,l.tel,l.cus,l.receiver ,lg.customer_no
    )
    select
     array_to_json(array_agg(row_to_json(t))) as trucks
    from t
#------------------------------------------------------------------------------------------
qryForReceiver: select
    l.customer_no
    ,l.receiver ,l.customer_no
    ,TO_CHAR(L.DN_DATE,'dd/MM/yyyy') as dn_date
    ,TO_CHAR(count(*),'990.00') as num_detail
    ,TO_CHAR(sum(l.wgt),'9990.99') as weight
    ,to_char(count(distinct l.car_regis_no) ,'990') as trucks
    from lh_dn l,line_lh_car_regis lg
    where l.dn_date = %(dn_date)s
    and (l.car_regis_no = lg.car_regis and lg.status='N')
    {{customer_no}}
    and l.status='A'
    group by l.customer_no,l.receiver,l.customer_no,l.dn_date
    order by l.receiver;
#------------------------------------------------------------------------------------------
qryReceiverDtl: SELECT
    array_to_json(array_agg(t))
    from
    (
        select
            l.car_regis_no,l.driver,l.tel,count(distinct l.coil_no) as coils,sum(l.wgt) as weight
            ,json_agg(
                row_to_json(
   	                ( select CoilDetail from (select l.product,l.coil_no,l.thk,l.wid,l.wgt) as CoilDetail (product,coil_no,thk,wid,wgt) )
                )
            ) as CoilDetail
        from lh_dn l where l.dn_date = %(dn_date)s and l.customer_no = %(customer_no)s  and l.receiver = %(receiver)s and l.status='A'
        group by l.car_regis_no,l.driver,l.tel
    )t
#------------------------------------------------------------------------------------------
qryForSubReceiver: select x.customer_no,x.receiver,x.truck_owner,x.dn_date
    ,TO_CHAR(count(*),'990.00') as num_detail
    ,TO_CHAR(sum(x.wgt),'9990.99') as weight
    ,to_char(count(distinct x.car_regis_no) ,'990') as trucks
    from (
        with dn as (
            select l.customer_no,l.receiver,TO_CHAR(l.DN_DATE,'dd/MM/yyyy') as dn_date, l.wgt,l.car_regis_no
            ,(select lg.customer_no from line_lh_car_regis lg where lg.car_regis=l.car_regis_no and lg.status='N') as truck_owner
            from lh_dn l
            {{inner_join_sub}}
            where l.dn_date = to_date(%(dn_date)s,'dd/mm/yyyy') and l.status='A'
            {{factory}}
        )
        select * from dn
    ) x
    group by x.customer_no,x.receiver,x.truck_owner,x.dn_date
#------------------------------------------------------------------------------------------
qrySubReceiverDtl: SELECT
    array_to_json(array_agg(t))
    from
    (
        select
            l.truck_no||' ['||l.car_regis_no||']' as car_regis_no,l.driver,l.tel,count(distinct l.coil_no) as coils,sum(l.wgt) as weight
            ,json_agg(
                row_to_json(
   	                ( select CoilDetail from (select l.product,l.coil_no,l.thk,l.wid,l.wgt) as CoilDetail (product,coil_no,thk,wid,wgt) )
                )
            ) as CoilDetail
        from lh_dn l ,line_lh_car_regis lg
		where l.dn_date = to_date(%(dn_date)s,'dd/mm/yyyy')
		and l.car_regis_no = lg.car_regis and lg.status='N'
	    and l.customer_no=%(customer_no)s and lg.customer_no = %(sub)s  and l.receiver = %(receiver)s and l.status='A'
        group by l.customer_no,l.car_regis_no,l.truck_no,l.driver,l.tel
    )t
#------------------------------------------------------------------------------------------
qrySendDocument: select
	l.customer_no
    ,to_char(l.dn_date,'dd/mm/yyyy') as dn_date
	,case when lk.wgt is null then '-' else to_char(lk.wgt,'999D999') end as wgt
	,case when lk.truck_no is null then '-' else lk.truck_no end as truck_no
	,case when lk.cus_doc is null then '-' else lk.cus_doc end as cus_doc
	,case when lk.dest_remark is null then '-' else lk.dest_remark end as dest_remark
	--,case when lk.truck_owner is null then '-' else lk.truck_owner end as truck_owner
    ,case when lk.tracking_no is null then '-' else lk.tracking_no end as tracking_no
	,case when lk.sending is null then '-' else lk.sending end as sender
    ,case when lk.last_updated is null then '-' else to_char(lk.last_updated,'dd/mm/yyyy HH24:MI:SS') end as send_date
    ,case when lk.eta_rtn is null then '-' else lk.eta_rtn end as eta_rtn
    from lh_dn l
    {{inner_join_sub}}
    left outer join  lh_dn_kerry lk on l.dn_no = lk.dn_no
    where l.dn_date between to_date(%(begin_date)s,'dd/mm/yyyy') and to_date(%(end_date)s,'dd/mm/yyyy') and l.status='A'
    {{factory}}
    order by l.dn_no
#------------------------------------------------------------------------------------------
qryTrucksPerDay: select array_to_json(array_agg(row_to_json(t)))
    from(
        with trucks as (
			select  distinct l.car_regis_no
			,(select lg.customer_no from line_lh_car_regis lg where lg.car_regis = l.car_regis_no and lg.status='N') as company
			from lh_dn l
			{{inner_join_sub}}
			where l.dn_date = to_date(%(dn_date)s,'dd/mm/yyyy') and l.status <>'D'
			{{factory}}
    	)
    	select company,count(*) as trucks from trucks
    	group by trucks.company order by 2 desc
    ) t
#------------------------------------------------------------------------------------------
#------------------- oracle parameter ใช้ : -------------------------------------------------
#----- หา พขร วิ่งงานในเดือน จาก lh)dn ------------------------------------
qryDNEmpInMonth: select l.emp_no,e.name||' '||e.surname as driver
    ,COUNT(DISTINCT L.DN_NO) as num_dn,e.social_no
    from lh_dn l
    INNER JOIN LINE_LH_CAR_REGIS LC ON LC.STATUS='N' AND LC.CAR_REGIS=L.CAR_REGIS_NO AND LC.CUSTOMER_NO='LTC'
    inner join employee e on e.emp_no=l.emp_no
    where l.dn_date between
    (select trunc(last_day(add_months(to_date(({{date_of_work}}),'dd/mm/rrrr'),-1))+1) from dual)
    and (select trunc(last_day(to_date(({{date_of_work}}),'dd/mm/rrrr')) )  from dual)
    GROUP BY l.emp_no,e.name||' '||e.surname,e.social_no
    order by l.emp_no
#------------------------------------------------------------------------------------------
qryDnBetweenDay: select  l.emp_no,e.name||' '||e.surname as driver
    ,COUNT(DISTINCT L.DN_NO),e.social_no
    from lh_dn l
    INNER JOIN LINE_LH_CAR_REGIS LC ON LC.STATUS='N' AND LC.CAR_REGIS=L.CAR_REGIS_NO AND LC.CUSTOMER_NO='LTC'
    inner join employee e on e.emp_no=l.emp_no
    where l.dn_date between to_date(:begin_date,'dd/mm/yyyy') and to_date(:end_date,'dd/mm/yyyy')
    GROUP BY l.emp_no,e.name||' '||e.surname,e.social_no
    order by l.emp_no
#------------------------------------------------------------------------------------------
qryAllDNinMonth: select  to_char(t.dn_date,'mm/yyyy') as mmyy,t.dn_no,t.truck_no,t.ton_km_amt,t.fuel_quan
    ,case when t.engine_type = 'N' then 'ก.ก.' else 'ลิตร' end as fuel_unit
    from tmp_new_payment t
    where t.dn_order='99'
    and t.dn_date between  trunc(last_day(add_months(t.dn_date,-1))+1) and  trunc(last_day(t.dn_date))
    order by t.shipment,t.new_old
#------------------------------------------------------------------------------------------
qryDNperDayByEmp: select  to_char(t.dn_date,'mm/yyyy') as mmyy,t.dn_no,t.truck_no,t.ton_km_amt,t.fuel_quan
    from tmp_new_payment t
    where t.dn_order='99'
    and t.dn_date between  trunc(last_day(add_months(t.dn_date,-1))+1) and  trunc(last_day(t.dn_date))
    order by t.shipment,t.new_old
#------------------------------------------------------------------------------------------
GetEmpWorksBetweenDate:  with emp as (
    select l.emp_no,e.social_no as id_card,e.name||' '||e.surname as driver
    ,case when l.dn_rtn is null then count(distinct l.dn_no)  else 0 end as FH
    ,case when l.dn_rtn is not null then  count(distinct l.dn_no)  else 0 end as BH
    from lh_dn l
    inner join line_lh_car_regis lc on lc.status='N' and  lc.car_regis=l.car_regis_no and lc.customer_no='LTC'
    inner join employee e on e.emp_no=l.emp_no
    where l.dn_date between to_date(:begin_date,'dd/mm/yyyy') and to_date(:end_date,'dd/mm/yyyy')
    group by l.dn_rtn,l.emp_no,e.social_no  ,e.name||' '||e.surname
    )
    select emp.emp_no,emp.id_card,emp.driver ,sum(emp.fh) as fh,sum(emp.bh) as bh
    from emp
    group by emp.emp_no,emp.id_card,emp.driver
#---------------------------------------------------------------------------------------------------
qryChkDNError: with dn_error as (
    select distinct l.dn_no
    ,tonkm_package.find_dn_chain(l.dn_no) as dn_chain
    ,(select count(*) from lh_dn l2 where l2.dn_rtn=l.dn_no) as error_count
    ,l.emp_no,e.name|| ' '||e.surname as driver
    from lh_dn l
    inner join line_lh_car_regis lc on lc.status='N' and  lc.car_regis=l.car_regis_no and lc.customer_no='LTC'
    inner join employee e on e.emp_no=l.emp_no
    where l.dn_date between to_date('{{begin_date}}','dd/mm/rrrr') and to_date('{{end_date}}','dd/mm/rrrr')
    and instr(tonkm_package.find_dn_chain(l.dn_no),'rror')>0
    )
    select dn_error.dn_no
    ,(select distinct t.truck_no from truck t where t.truck_register_no=l.car_regis_no) as truck_no
    ,dn_error.emp_no,dn_error.driver
    ,dn_error.dn_chain as error,dn_error.error_count,l.dn_no as bh_dn,'อ้างอิง dn '||dn_error.dn_no||' ก่อนหน้าผิด'  as remark
    from dn_error
    join lh_dn l on l.dn_rtn = dn_error.dn_no

    union all

    select distinct l.dn_no
    ,(select distinct t.truck_no from truck t where t.truck_register_no=l.car_regis_no) as truck_no
    ,l.emp_no,e.name|| ' '||e.surname as driver
    ,'error อ้างอิงตัวเอง',1,l.dn_rtn,l.dn_no||' อ้างอิงตัวเอง'
    from lh_dn l
    inner join employee e on e.emp_no=l.emp_no
    where l.dn_date between to_date('{{begin_date}}','dd/mm/rrrr') and to_date('{{end_date}}','dd/mm/rrrr')
    and l.dn_no=l.dn_rtn

    union all

    select distinct l.dn_no
    ,(select distinct t.truck_no from truck t where t.truck_register_no=l.car_regis_no) as truck_no
    ,l.emp_no,e.name|| ' '||e.surname as driver
    ,'error อ้างอิงมากเกิน',1,l.dn_no,tonkm_package.find_dn_chain(l.dn_no)
    from lh_dn l
    inner join employee e on e.emp_no=l.emp_no
    where l.dn_date between to_date('{{begin_date}}','dd/mm/rrrr') and to_date('{{end_date}}','dd/mm/rrrr')
    and length(tonkm_package.find_dn_chain(l.dn_no))>60
    union all
    select distinct l.dn_no,lc.truck_no
    ,l.emp_no,e.name|| ' '||e.surname as driver
    ,'error',0,tonkm_package.find_dn_chain(l.dn_no),'error FH ไม่มีจุดจอด HUB'
    from lh_dn l
    INNER JOIN LINE_LH_CAR_REGIS LC ON LC.STATUS='N' AND LC.CAR_REGIS = L.CAR_REGIS_NO AND LC.CUSTOMER_NO='LTC'   --เฉพาะรถ LINE เท่านั้น
    inner join employee e on e.emp_no=l.emp_no
    where l.dn_date between to_date('{{begin_date}}','dd/mm/rrrr') and to_date('{{end_date}}','dd/mm/rrrr')
    and l.dn_rtn is null ---
    and not exists (select  1 from lh_dn_start_stop ls where ls.dn_no = l.dn_no)

    union all

    select DISTINCT
    l.dn_no,lc.truck_no,l.emp_no,e.name||' '||e.surname as driver,'NO ADD',1,L.DN_NO,'งาน '||l.customer_no||' '||'ไม่ระบุปลายทาง'
    from lh_dn l
    inner join request r on r.job_no=l.job_no
    inner join employee e on e.emp_no=l.emp_no
    join line_lh_car_regis lc on lc.status='N' and lc.car_regis=l.car_regis_no and lc.customer_no='LTC'
    where l.dn_date between  to_date('{{begin_date}}','dd/mm/rrrr') and to_date('{{end_date}}','dd/mm/rrrr')
    and (r.source_point = 'NOAD' OR R.RECEIVER='NOAD')

    union all

    select d.dn_no,d.truck_no,d.driver_no,e.name|| ' '||e.surname as driver,'Error ระยะทาง 0',1,d.dn_no,d.source_point||' - '||d.receiver as remark
    from dn_distance d
    inner join employee e on e.emp_no=d.driver_no
    where d.dn_date between to_date('{{begin_date}}','dd/mm/rrrr') and to_date('{{end_date}}','dd/mm/rrrr')
    AND D.SOURCE_POINT <> D.RECEIVER
    and d.distance=0
#---------------------------------------------------------------------------------------------------
qryAllowanceByEmp1: select  e.emp_no,e.name||' '||e.surname as driver ,e.tel,e.social_no
    ,count(distinct t.dn_no)
    ,sum(case when t.dn_type in ('F','B') and t.dn_order<>'99' then km_adj else 0 end) as KM_ADJ_LOAD
    ,sum(case when t.dn_type not in ('F','B') and t.dn_order<>'99' then km_adj else 0 end) as KM_ADJ_NOLOAD
    ,sum(case when t.dn_order='99' then t.ton_km_amt else 0 end) as ton_km_amt
    ,sum(case when t.dn_order='99' and t.engine_type ='N' then t.fuel_quan else 0 end) as FUEL_NGV
    ,sum(case when t.dn_order='99' and t.engine_type <> 'N' then t.fuel_quan else 0 end) as FUEL_DIESEL
    ,sum(case when t.dn_order='99' then t.multidrop else 0 end) as multidrop
    ,sum(case when t.dn_order = '99' then t.difficulty else 0 end ) as difficulty
    from tmp_new_payment t
    inner join employee e on e.emp_no=t.emp_no
    where t.dn_date between to_date(:begin_date,'dd/mm/rrrr') and to_date(:end_date,'dd/mm/rrrr')
    GROUP BY e.emp_no,e.name||' '||e.surname ,E.TEL,e.social_no
#---------------------------------------------------------------------------------------------------
qryAllowanceByEmp2: select t.dn_no         --0
    ,to_char(t.dn_date,'dd/mm/yyyy') as dn_date  --1
    ,t.truck_no  --2
    ,tonkm_package.engine_type(t.engine_type) as engine_type  --3
    ,TONKM_PACKAGE.find_multidrop_name(T.DN_NO) as multidrop_place  --4
    ,t.ton_km_amt  --5
    ,(case when t.engine_type ='N' then t.fuel_quan else 0 end) as fuel_ngv --6
    ,(case when t.engine_type <>'N' then t.fuel_quan else 0 end) as fuel_diesel  --7
    ,t.multidrop  --8
    ,t.difficulty  --9
    ,nvl((select sum(lg.gas_quan) from advance_lh a inner join lh_gas lg on lg.adv_no=a.adv_no
            and lg.gas_type<>'E' where a.dn_no=t.dn_no),0) as fuel_used
    from tmp_new_payment t
    where t.dn_date between to_date(:begin_date,'dd/mm/rrrr') and to_date(:end_date,'dd/mm/rrrr')
    and t.dn_order='99'
    order by t.shipment,t.dn_no,t.dn_order
#---------------------------------------------------------------------------------------------------
qryAllowanceByEmp3: select t.dn_order
    ,nvl(t.product_desc,'-') as product
    ,t.source_point
    ,t.receiver
    ,t.weight,t.km_adj,t.ton_km_amt,t.fuel_quan
    ,case when t.engine_type ='N' then 'ก.ก.' else 'ลิตร' end as fuel_unit
    ,t.multidrop,t.difficulty
    ,t.trans_remark
    ,t.remark
    ,(case when (t.source_point <> t.receiver) and t.distance=0 then 'adj_distance' else '-' end) adj_distance
    from tmp_new_payment t
    where t.dn_date between to_date(:begin_date,'dd/mm/rrrr') and to_date(:end_date,'dd/mm/rrrr')
    and t.dn_no='{{dn_no}}' and t.dn_order <>'99'
    order by t.shipment,t.dn_no,t.dn_order
#---------------------------------------------------------------------------------------------------
qryFuelUsed:   SELECT SUM(X.NGV_USED) AS NGV_USED ,SUM(X.DIESEL_USED) AS DIESEL_USED
    FROM (
        SELECT
        CASE WHEN T.ENGINE_TYPE='N' THEN
           NVL(sum(lg.gas_quan),0)
        ELSE 0
        END AS NGV_USED
        ,CASE WHEN T.ENGINE_TYPE<>'N' THEN
           NVL(sum(lg.gas_quan),0)
        ELSE 0
        END AS DIESEL_USED
        FROM TMP_NEW_PAYMENT T
        left outer join advance_lh a on a.dn_no=t.dn_no
        left outer join lh_gas lg on lg.adv_no=a.adv_no and lg.gas_type<>'E'
        where t.dn_date between to_date(:begin_date,'dd/mm/rrrr') and to_date(:end_date,'dd/mm/rrrr')
        and t.dn_order='99'
        GROUP BY T.ENGINE_TYPE
    ) X
#---------------------------------------------------------------------------------------------------
qryAllTonKM: select x.dn_order,x.truck_no,x.emp_no ,e.name||' '||e.surname as driver_name
    ,to_char(x.dn_date,'dd/mm/yyyy') as dn_date
    ,X.DN_NO
    ,x.product_desc as product
    ,x.source_point,x.receiver
    ,x.weight,x.distance,x.km_adj,x.ton_km_amt
    ,TONKM_PACKAGE.engine_type(x.engine_type) AS ENGINE_TYPE
    ,x.fuel_rate
    ,x.fuel_quan
    ,x.multidrop
    ,x.difficulty
    ,x.trans_remark
    ,x.remark
    from tmp_new_payment x
    inner join employee e on e.emp_no=x.emp_no
    order by x.emp_no,x.shipment,x.dn_no,x.dn_order
#---------------------------------------------------------------------------------------------------
qryDNperDay: select t.dn_no,t.ton_km_amt,t.fuel_quan,t.engine_type
      ,case when engine_type = 'N' then 'ก.ก.' else 'ลิตร' end as fuel_unit
      ,truck_no
      ,tonkm_package.find_multidrop_name(dn_no)
      ,trim(tonkm_package.find_multidrop_point(dn_no))
      ,(select sum(km_adj) from tmp_new_payment t2 where t2.dn_no = t.dn_no and t2.dn_order <>'99'
      and t2.dn_type in ('F','B') ) as km_load
      ,(select sum(km_adj) from tmp_new_payment t2 where t2.dn_no = t.dn_no and t2.dn_order <>'99' and
      t2.dn_type not in ('F','B') ) as km_noload
      ,tonkm_package.find_multidrop_value(dn_no) , t.difficulty
      ,nvl((select sum(lg.gas_quan) from advance_lh a inner join lh_gas lg on lg.adv_no = a.adv_no and lg.gas_type<>'E' where a.dn_no=t.dn_no),0) as fuel_used
      ,(case when (select min(t2.distance) from tmp_new_payment t2 where t2.dn_no=t.dn_no and t2.dn_order<>'99' and t2.source_point<>t2.receiver) = 0
              then 'รอแก้ไขระยะทาง' else 'good' end ) as remark
      from tmp_new_payment t
     where dn_order = '99' and dn_date between  to_date(:begin_date ,'dd/mm/yyyy') and to_date(:end_date,'dd/mm/yyyy')
     order by shipment,dn_order
#---------------------------------------------------------------------------------------------------
qryEmpTimestamp: select x.emp_no,x.driver,x.truck_no
    ,(case when x.ENERGY_TYPE = 'H' then 'ดีเซลใหม่'
          when x.ENERGY_TYPE = 'N' then 'NGV'
          when x.ENERGY_TYPE = 'C' then 'ดีเซลเปลี่ยนเครื่อง'
          when  x.ENERGY_TYPE = 'F' then 'ดีเซลเก่า'
    end ) as ENERGY_TYPE
    ,x.job_no  ,x.dn_no,to_char(x.dn_date,'dd/mm/yyyy'),x.source_point,x.source_name,x.source_addr3,x.lat_lng,x.remark1,x.dn_type
    from (
        select
        d.shipment ,d.dn_order,d.EMP_NO,E.NAME||' '||E.SURNAME AS DRIVER
        ,d.truck_no,d.dn_no,d.source_point,C.CUSTOMER_NAME as source_name,C.ADDRESS3 as source_addr3
        ,(select l.source_lat||','||l.source_long from lh_distance l where l.source_point = d.source_point and l.receiver=d.receiver) as lat_lng
        ,d.dn_type
        ,(case when d.dn_order = 5 then 'จุดตั้งต้น'
              when d.dn_order = 10 then 'ขึ้นสินค้าขาขึ้น'
              when d.dn_order =15 then 'ส่งสินค้าขาขึ้น'
              when d.dn_order in ( 20,30,40,50,60,70,80) then 'ขึ้นสินค้าขาลง'||( (d.dn_order-20)/10+1)
              when d.dn_order in ( 25,35,45,55,65,75,85)  then 'ส่งสินค้าขาลง'||((d.dn_order - 25)/10+1)
         end) as remark1
        ,LC.ENERGY_TYPE
        from tmp_new_payment d
        INNER JOIN CUSTOMER C ON C.CUSTOMER_NO = d.SOURCE_POINT
        INNER JOIN EMPLOYEE E ON E.EMP_NO=d.emp_no
        INNER JOIN LINE_LH_CAR_REGIS LC ON LC.TRUCK_NO=D.TRUCK_NO AND LC.STATUS='N'

        union all

        select d.shipment,99,d.EMP_NO,E.NAME||' '||E.SURNAME AS DRIVER
        ,d.truck_no,d.dn_no,d.receiver,C.CUSTOMER_NAME as source_name,C.ADDRESS3 as source_addr3
        ,(select max(l.source_lat||','||l.source_long) from lh_distance l where l.source_point =d.receiver) as lat_lng
        ,d.dn_type,'กลับจุดจอด',LC.ENERGY_TYPE
        from tmp_new_payment d
        inner join lh_distance l on l.source_point=d.source_point and l.receiver=d.receiver
        INNER JOIN CUSTOMER C ON C.CUSTOMER_NO = d.receiver
        INNER JOIN EMPLOYEE E ON E.EMP_NO=d.emp_no
        INNER JOIN LINE_LH_CAR_REGIS LC ON LC.TRUCK_NO=D.TRUCK_NO AND LC.STATUS='N'
        where d.dn_type='E'
    ) x
    order by x.dn_no,x.dn_order
#---------------------------------------------------------------------------------------------------
qryForTimestamp: select x.emp_no,x.social_no,x.driver,x.truck_no
    ,(case when x.ENERGY_TYPE = 'H' then 'ดีเซลใหม่'
              when x.ENERGY_TYPE = 'N' then 'NGV'
              when x.ENERGY_TYPE = 'C' then 'ดีเซลเปลี่ยนเครื่อง'
             when  x.ENERGY_TYPE = 'F' then 'ดีเซลเก่า'
     end )as ENERGY_TYPE
     ,x.job_no  ,x.dn_no,x.dn_order, to_char(x.dn_date,'dd/mm/yyyy') as dn_date,x.source_point,x.source_name,x.source_addr3,x.lat_lng,x.remark1,x.dn_type
     ,x.ADDRESS1
    from (
        select
        d.shipment ,d.dn_order,d.EMP_NO,E.NAME||' '||E.SURNAME AS DRIVER,e.social_no
        ,d.truck_no
        ,tonkm_package.find_multidrop_job(d.dn_no) as job_no ,d.dn_no,d.dn_date
        ,d.source_point,C.CUSTOMER_NAME as source_name,C.ADDRESS3 as source_addr3
        ,(select l.source_lat||','||l.source_long from lh_distance l where l.source_point = d.source_point and l.receiver=d.receiver) as lat_lng
        ,d.dn_type
        ,case when d.dn_order = 5 then 'จุดตั้งต้น'
              when d.dn_order = 10 then 'ขึ้นสินค้าขาขึ้น'
              when d.dn_order =15 then 'ส่งสินค้าขาขึ้น'
              when d.dn_order in ( 20,30,40,50,60,70,80) then 'ขึ้นสินค้าขาลง'||( (d.dn_order-20)/10+1)
              when d.dn_order in ( 25,35,45,55,65,75,85)  then 'ส่งสินค้าขาลง'||((d.dn_order - 25)/10+1)
         end as remark1
         ,d.remark
        ,LC.ENERGY_TYPE,C.ADDRESS1
        from tmp_new_payment d
        INNER JOIN CUSTOMER C ON C.CUSTOMER_NO = d.SOURCE_POINT
        INNER JOIN EMPLOYEE E ON E.EMP_NO=d.emp_no
        INNER JOIN LINE_LH_CAR_REGIS LC ON LC.TRUCK_NO=D.TRUCK_NO AND LC.STATUS='N'
    union all
        select d.shipment,99,d.EMP_NO,E.NAME||' '||E.SURNAME AS DRIVER,e.social_no
        ,d.truck_no
        ,tonkm_package.find_multidrop_job(d.dn_no) as job_no,d.dn_no,d.dn_date
        ,d.receiver,C.CUSTOMER_NAME as source_name,C.ADDRESS3 as source_addr3
        ,(select max(l.source_lat||','||l.source_long) from lh_distance l where l.source_point =d.receiver) as lat_lng
        ,d.dn_type,'กลับจุดจอด',LC.ENERGY_TYPE,d.remark,C.ADDRESS1
        from tmp_new_payment d
        inner join lh_distance l on l.source_point=d.source_point and l.receiver=d.receiver
        INNER JOIN CUSTOMER C ON C.CUSTOMER_NO = d.receiver
        INNER JOIN EMPLOYEE E ON E.EMP_NO=d.emp_no
        INNER JOIN LINE_LH_CAR_REGIS LC ON LC.TRUCK_NO=D.TRUCK_NO AND LC.STATUS='N'
       where d.dn_type='E'
    ) x
    order by
    x.dn_no,x.dn_order
#---------------------------------------------------------------------------------------------------
qryEmpDnBetweenDate: select distinct to_char(l.dn_date,'dd/mm/yyyy') as dn_date
    ,l.dn_no,tonkm_package.find_multidrop_job(l.dn_no) as job_no
    ,(select max(r.source_point) from request r where r.job_no in (select job_no from lh_dn  l2 where l2.dn_no = l.dn_no)) as start_place
    ,tonkm_package.find_multidrop_name(l.dn_no) as destination_place
    from lh_dn l where l.dn_date between :begin_date and :end_date and l.emp_no = :emp_no
    order by l.dn_no desc
# ---------------------------------------------------------------------------------------------------
# ---------------------- postgres12 -----------------------------------------------------------------
# ins_dn_timestamp: insert into dn_timestamp(data) values('{{data}}'::jsonb)
ins_dn_timestamp: select ins_dn_timestamp('{{data}}'::jsonb)

qry_in_out: with md5 as (
      select min(data->>'MD5') as md5 from dn_timestamp t where t.data->>'DN_NO' = '{{dn_no}}' and t.data->>'EMP_NO'='{{emp_no}}'
    )
    select 	d.data->>'MD5' as md5,(d.data->>'DN_ORDER')::int as dn_order,d.data->>'IN_OUT' as in_out
    from dn_timestamp d where d.data->>'MD5' = (select md5 from md5)
    order by d.id desc limit 1
#---------------------------------------------------------------------------------------------------
getDNTimeStamp: with dn as (
     select min(data->>'MD5') as md5 from dn_timestamp t where t.data->>'DN_NO' = '{{dn_no}}'
    )
    select d.data->'DN_NO' as dn_no,d.data->'TRUCK_NO' as truck_no,d.data->'EMP_NO' as emp_no
    ,d.data->'SOURCE_POINT' as source_point
    ,d.data->'LAT_LNG' as lat_lng
    ,d.data->'IN_OUT' as in_out
    ,d.data->'POSITION' as mobile_data
    ,d.data->'TRUCK_POSITION' as truck_data
    from dn_timestamp d where d.data->>'MD5' = (select md5 from DN)
    order by d.data->>'DN_NO' ,(d.data->>'DN_ORDER')::int
#---------------------------------------------------------------------------------------------------
#----- ใช้ใน GetEmpPaymentLH.py----------------------------------------------------------------------
qryEmpPaymentLH: select
    pd.dn_no,
    pd.quotation_desc AS QUOTATION_DESC
    ,pd.dn_date,pd.car_regis_no
    ,nvl(pd.allowance,0) as allowance
    ,pd.amount
    ,PD.GAS_PER_TRIP,PD.GAS_SPECIAL
    ,pd.adjust_amount
    ,pd.adjust_remark
    ,PD.GAS_QUAN
    ,PD.GAS_OPERA
    ,(PD.GAS_QUAN - PD.GAS_OPERA) AS GAS_DIFF
    ,PD.GAS_PRICE
    ,(PD.DIESEL_QUAN-PD.DIESEL_OPERA) AS DIESEL_DIFF
    ,PD.DIESEL_QUAN
    ,PD.DIESEL_OPERA
    ,PD.DIESEL_PRICE
    ,PD.PAID_AMOUNT
    --,nvl((select a.allowance_amount from allowance_lh a where a.period = substr(p.work_date_end,7,4)||'/'||substr(p.work_date_end,4,2) and a.emp_no=pd.emp_no) ,0) as allowance_amount
    ,0 as allowance_amount
    ,PD.ENERGY_TYPE
    ,nvl(pd.lift,0) as lift,nvl(pd.difficulty,0) as difficulty,nvl(pd.multidrop,0) as multidrop
    from payment_lh p,payment_lh_dtl pd,EMPLOYEE E
    where p.payment_date = :payment_date
    and pd.emp_no = :emp_no
    and p.payment_date = pd.payment_date
    AND  PD.EMP_NO = E.EMP_NO
    order by pd.payment_date,pd.emp_no,pd.dn_date,pd.dn_no
#---------------------------------------------------------------------------------------------------
#----- ใช้ใน GetEmpPaymentLH.py----------------------------------------------------------------------
qryEmpFixTire: SELECT E.EMP_NO,E.NAME||' '||E.SURNAME,LD.AMOUNT_TIRE
    FROM LH_DRIVER LD
    inner join employee e on e.emp_no=ld.emp_no
    WHERE LD.EMP_NO= :emp_no
    AND to_date(:payment_date,'dd/mm/yyyy')  BETWEEN LD.DATE_IN AND LD.DATE_OUT
#---------------------------------------------------------------------------------------------------
