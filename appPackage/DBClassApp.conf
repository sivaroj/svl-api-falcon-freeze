[Ora]
user: svlreader
pass: svlreader
service: TRANS
server: 192.168.0.2
port: 1521
[Postgresql]
server: 192.168.0.104
#server: 192.168.0.191
port: 5432
database: transport
pg_user: transport
pg_pass: transport_yak55sp
[PostgresqlV12]
server: 192.168.0.191
port: 5432
database: transport
[Query]
qrySumLh_dn: select
    to_char( sum(l.wgt),'99999D999' ) as total_weight
    , to_char(count(distinct l.car_regis_no),'9999' ) as total_trucks
    , to_char(count(l.coil_no),'9999' ) as total_coils
    , to_char(count(distinct l.receiver),'9999') as total_receiver
    , to_char(count(distinct l.dn_no),'9999') as total_dn
    from lh_dn l
    {{inner_join_sub}}
    where l.dn_date = to_date(%(dn_date)s,'dd/mm/yyyy') and l.status='A'
    {{factory}}
#------------------------------------------------------------------------------------------
qrySumSubLh_dn: select
    to_char( sum(l.wgt),'99999D999' ) as total_weight
    , to_char(count(distinct l.car_regis_no),'9999' ) as total_trucks
    , to_char(count(l.coil_no),'9999' ) as total_coils
    , to_char(count(distinct l.receiver),'9999') as total_receiver
    , to_char(count(distinct l.dn_no),'9999') as total_dn
    from lh_dn l
    {{inner_join_sub}}
	where l.dn_date = to_date(%(dn_date)s,'dd/mm/yyyy')
    {{factory}}
#------------------------------------------------------------------------------------------
qrySumSubProduct: select x.product,
	   to_char(x.weight,'99999D999') as weight,
	   to_char(round(x.weight / sum(x.weight) over() * 100,2),'999D99') as pct,
	   x.trucks
    from (
        select l.product,sum(l.wgt) as weight,count(distinct l.car_regis_no)  as trucks
        from lh_dn l
        {{inner_join_sub}}
        where l.dn_date = to_date(%(dn_date)s,'dd/mm/yyyy') and l.status='A'
        {{factory}}
        group by l.product
    ) x
#------------------------------------------------------------------------------------------
qrySumProduct: select x.product, to_char(x.weight,'99999D999') as weight, to_char(round(x.weight / sum(x.weight) over() * 100,2),'999D99') as pct
    , x.trucks
    from (
        select l.product,sum(l.wgt) as weight,count(distinct l.car_regis_no)  as trucks
        from lh_dn l
        {{inner_join_sub}}
        where l.dn_date = to_date(%(dn_date)s,'dd/mm/yyyy') and l.status='A'
        {{factory}}
        group by l.product
    ) x
#------------------------------------------------------------------------------------------
qrySumFactoryProduct: select x.customer_no
    ,(case when x.product is null then 'Total' else x.product end ) as product
    ,to_char(x.weight,'99999D999') as weight
    ,to_char(round(x.weight / sum(x.weight) over() * 100,2),'999D99') as pct
    ,case when x.product is not null then coalesce(x.trucks||'') else '' end as truck
    ,COALESCE((select c.coil_remain||'' from coil_remain c where c.customer_no=x.customer_no and c.dn_date= to_date( %(dn_date)s, 'dd/mm/yyyy') and c.product = x.product),'0') as coil_remain
    ,(case when (select 1 from associated_comp where company=x.customer_no and logistics='LH' limit 1) = 1 then 'true' else 'false' end ) as associated
    from (
    with t as (
        select l.customer_no,l.product,count(distinct l.car_regis_no)  as trucks,sum(l.wgt) as weight
        from lh_dn l
        {{inner_join_sub}}
        where l.dn_date = to_date( %(dn_date)s, 'dd/mm/yyyy') and l.status='A'
        {{factory}}
        group by rollup (l.customer_no,l.product)
    )
    select *
    from t as t1
    where ( 2 = (select count(*) from t as t2 where t1.customer_no = t2.customer_no) and t1.product is not null)
    or ( 2 < (select count(*) from t as t2 where t1.customer_no = t2.customer_no) )
    ) x

#------------------------------------------------------------------------------------------
qrySumFactoryProduct2: 	with t as (
        with c as (
                select l.customer_no,l.product
                ,count(distinct l.car_regis_no) as trucks
                ,sum(l.wgt) as weight
                ,0 as coil_remain
                from lh_dn l
                inner join line_lh_car_regis lc on lc.car_regis  = l.car_regis_no and lc.status ='N'
                where  l.dn_date = to_date(%(dn_date)s,'dd/mm/yyyy') and l.status ='A' {{factory}}
                group by  l.customer_no ,l.product
                {{coil_remain}}
        )
        select c.customer_no,c.product
        ,sum(c.trucks) as trucks,sum(c.weight) as weight,sum(c.coil_remain) as coil_remain
        from c
        group by rollup (c.customer_no,c.product)
    )
    select t1.customer_no
    ,(case when t1.product is null then '--Total--' else t1.product end ) as product
    ,to_char(t1.weight,'99990D999') as weight
    ,to_char((t1.weight/(select sum(t2.weight) + sum(t2.coil_remain) from t as t2 where t2.customer_no = t1.customer_no and t2.product is not null))*100,'990D99') as pct
    ,to_char(t1.trucks,'990') as trucks
    ,to_char(t1.coil_remain ,'99990D999') as coil_remain
    ,case when ac.logistics ='LH' then 'true' else 'false' end as associated
    from t as t1
    left outer join associated_comp  ac on ac.company =t1.customer_no
        where ( 2 = (select count(*) from t as t2 where t1.customer_no = t2.customer_no) and t1.product is not null)
        or ( 2 < (select count(*) from t as t2 where t1.customer_no = t2.customer_no) )
    order by t1.customer_no, t1.product

#------------------------------------------------------------------------------------------
qryDnTrucks: select l.customer_no,l.car_regis_no,l.truck_no
    ,to_char(sum(CASE WHEN (l.status='A') THEN 1     ELSE 0 END),'999') AS coils
    ,to_char(sum(CASE WHEN (l.status='A') THEN l.wgt   ELSE 0 END),'999.99') AS  wgt
    ,to_char(SUM(distinct CASE WHEN (l.status='D') THEN 1     ELSE 0 END),'9') AS haveCancel
    from lh_dn l
    {{inner_join_sub}}
	where l.dn_date = to_date( %(dn_date)s , 'dd/mm/yyyy')
    {{factory}}
    group by l.customer_no,l.car_regis_no,l.truck_no;
#------------------------------------------------------------------------------------------
qryCoilsOnTruck: SELECT
    array_to_json(array_agg(t))
    from
    (
        select l.emp_no,l.driver,l.tel
        ,(CASE WHEN (l.status='D') THEN '*** ยกเลิก DN ***'     ELSE l.receiver END) as receiver
        ,l.status,count(distinct l.coil_no) as coils,sum(l.wgt) as weight
        ,json_agg(
            row_to_json(
   	            ( select CoilDetail from (select l.dn_no,l.product,l.coil_no,l.cus_job_no,l.cus,l.thk,l.wid,l.wgt) as CoilDetail (dn_no,product,coil_no,cus_job_no,cus,thk,wid,wgt) )
            )
        ) as CoilDetail
    from lh_dn l where l.dn_date = to_date( %(dn_date)s , 'dd/mm/yyyy') and l.customer_no = %(company)s and l.car_regis_no = %(car_regis_no)s
    group by l.receiver,l.status,l.emp_no,l.driver,l.tel
    )t;
#------------------------------------------------------------------------------------------
qryGetCusOrder: select
    l.cus,l.receiver,count(distinct l.car_regis_no) as truck,to_char(sum(l.wgt),'9990.999') as wgt
    ,l.customer_no
    from lh_dn l
    inner join line_lh_car_regis lg on lg.car_regis = l.car_regis_no and lg.status='N'
    {{inner_join_sub}}
    where l.dn_date= to_date(%(dn_date)s,'dd/mm/yyyy') and l.status='A'
    {{factory}}
    group by l.cus,l.receiver,l.customer_no;
#------------------------------------------------------------------------------------------
qryGetCusOrderDtl: with t as
    (
         select  l.car_regis_no,l.driver,l.tel,count(distinct l.coil_no) as coils,sum(l.wgt) as weight,l.cus
         ,l.receiver ,lg.customer_no as supplier
         ,json_agg(
                    row_to_json(
                        ( select CoilDetail from (select l.product,l.coil_no,l.thk,l.wid,l.wgt) as CoilDetail
                        (product,coil_no,thk,wid,wgt) )
                    )
                ) as CoilDetail
         from lh_dn l
             inner join line_lh_car_regis lg on lg.car_regis = l.car_regis_no and lg.status='N'
             {{inner_join_sub}}
              where l.dn_date = to_date(%(dn_date)s,'dd/mm/yyyy')
              {{factory}}
              {{cus}}
              and l.receiver = %(receiver)s
              and l.status='A'
          group by l.car_regis_no,l.driver,l.tel,l.cus,l.receiver ,lg.customer_no
    )
    select
     array_to_json(array_agg(row_to_json(t))) as trucks
    from t
#------------------------------------------------------------------------------------------
qryForReceiver: select
    l.customer_no
    ,l.receiver ,l.customer_no
    ,TO_CHAR(L.DN_DATE,'dd/MM/yyyy') as dn_date
    ,TO_CHAR(count(*),'990.00') as num_detail
    ,TO_CHAR(sum(l.wgt),'9990.99') as weight
    ,to_char(count(distinct l.car_regis_no) ,'990') as trucks
    from lh_dn l,line_lh_car_regis lg
    where l.dn_date = %(dn_date)s
    and (l.car_regis_no = lg.car_regis and lg.status='N')
    {{customer_no}}
    and l.status='A'
    group by l.customer_no,l.receiver,l.customer_no,l.dn_date
    order by l.receiver;
#------------------------------------------------------------------------------------------
qryReceiverDtl: SELECT
    array_to_json(array_agg(t))
    from
    (
        select
            l.car_regis_no,l.driver,l.tel,count(distinct l.coil_no) as coils,sum(l.wgt) as weight
            ,json_agg(
                row_to_json(
   	                ( select CoilDetail from (select l.product,l.coil_no,l.thk,l.wid,l.wgt) as CoilDetail (product,coil_no,thk,wid,wgt) )
                )
            ) as CoilDetail
        from lh_dn l where l.dn_date = %(dn_date)s and l.customer_no = %(customer_no)s  and l.receiver = %(receiver)s and l.status='A'
        group by l.car_regis_no,l.driver,l.tel
    )t
#------------------------------------------------------------------------------------------
qryForSubReceiver: select x.customer_no,x.receiver,x.truck_owner,x.dn_date
    ,TO_CHAR(count(*),'990.00') as num_detail
    ,TO_CHAR(sum(x.wgt),'9990.99') as weight
    ,to_char(count(distinct x.car_regis_no) ,'990') as trucks
    from (
        with dn as (
            select l.customer_no,l.receiver,TO_CHAR(l.DN_DATE,'dd/MM/yyyy') as dn_date, l.wgt,l.car_regis_no
            ,(select lg.customer_no from line_lh_car_regis lg where lg.car_regis=l.car_regis_no and lg.status='N') as truck_owner
            from lh_dn l
            {{inner_join_sub}}
            where l.dn_date = to_date(%(dn_date)s,'dd/mm/yyyy') and l.status='A'
            {{factory}}
        )
        select * from dn
    ) x
    group by x.customer_no,x.receiver,x.truck_owner,x.dn_date
#------------------------------------------------------------------------------------------
qrySubReceiverDtl: SELECT
    array_to_json(array_agg(t))
    from
    (
        select
            l.truck_no||' ['||l.car_regis_no||']' as car_regis_no,l.driver,l.tel,count(distinct l.coil_no) as coils,sum(l.wgt) as weight
            ,json_agg(
                row_to_json(
   	                ( select CoilDetail from (select l.product,l.coil_no,l.thk,l.wid,l.wgt) as CoilDetail (product,coil_no,thk,wid,wgt) )
                )
            ) as CoilDetail
        from lh_dn l ,line_lh_car_regis lg
		where l.dn_date = to_date(%(dn_date)s,'dd/mm/yyyy')
		and l.car_regis_no = lg.car_regis and lg.status='N'
	    and l.customer_no=%(customer_no)s and lg.customer_no = %(sub)s  and l.receiver = %(receiver)s and l.status='A'
        group by l.customer_no,l.car_regis_no,l.truck_no,l.driver,l.tel
    )t
#------------------------------------------------------------------------------------------
qrySendDocument: select
	l.customer_no
    ,to_char(l.dn_date,'dd/mm/yyyy') as dn_date
	,case when lk.wgt is null then '-' else to_char(lk.wgt,'999D999') end as wgt
	,case when lk.truck_no is null then '-' else lk.truck_no end as truck_no
	,case when lk.cus_doc is null then '-' else lk.cus_doc end as cus_doc
	,case when lk.dest_remark is null then '-' else lk.dest_remark end as dest_remark
	--,case when lk.truck_owner is null then '-' else lk.truck_owner end as truck_owner
    ,case when lk.tracking_no is null then '-' else lk.tracking_no end as tracking_no
	,case when lk.sending is null then '-' else lk.sending end as sender
    ,case when lk.last_updated is null then '-' else to_char(lk.last_updated,'dd/mm/yyyy HH24:MI:SS') end as send_date
    ,case when lk.eta_rtn is null then '-' else lk.eta_rtn end as eta_rtn
    from lh_dn l
    {{inner_join_sub}}
    left outer join  lh_dn_kerry lk on l.dn_no = lk.dn_no
    where l.dn_date between to_date(%(begin_date)s,'dd/mm/yyyy') and to_date(%(end_date)s,'dd/mm/yyyy') and l.status='A'
    {{factory}}
    order by l.dn_no
#------------------------------------------------------------------------------------------
qryTrucksPerDay: WITH DN AS (
      SELECT L.SUPPLIER_NO
      ,COUNT(DISTINCT CASE WHEN L.CUS_COIL_NO NOT LIKE '%RE%' THEN  L.CAR_REGIS_NO ELSE NULL END ) AS FH_TRUCKS
      ,SUM( CASE WHEN L.CUS_COIL_NO NOT LIKE '%RE%' THEN L.WGT ELSE 0 END ) AS FH_WGT
      ,COUNT(DISTINCT CASE WHEN L.CUS_COIL_NO LIKE '%RE%' THEN  L.CAR_REGIS_NO ELSE NULL END ) AS BH_TRUCKS
      ,SUM( CASE WHEN L.CUS_COIL_NO LIKE '%RE%' THEN L.WGT ELSE 0 END ) AS BH_WGT
      FROM LH_DN L WHERE L.DN_DATE = to_date(:dn_date,'dd/mm/yyyy') {{factory}} {{inner_join_sub}}
      GROUP BY L.SUPPLIER_NO
    )
    SELECT DN.SUPPLIER_NO,LS.CUSTOMER_NAME
    ,SUM(DN.FH_TRUCKS) AS FH_TRUCKS
    ,SUM(DN.FH_WGT) AS FH_WGT
    ,SUM(DN.BH_TRUCKS) AS BH_TRUCKS
    ,SUM(DN.BH_WGT) AS BH_WGT
    ,(select count(distinct l.car_regis_no) from lh_dn l
        where l.supplier_no=dn.supplier_no and l.dn_date = to_date(:dn_date,'dd/mm/yyyy')
        {{inner_join_sub}} {{factory}} )  as total_trucks
    FROM DN
    INNER JOIN LINE_LH_SUBCONTRACT LS ON LS.CUSTOMER_NO = DN.SUPPLIER_NO
    GROUP BY DN.SUPPLIER_NO,LS.CUSTOMER_NAME
    ORDER BY 7 DESC,3 desc,2
#------------------------------------------------------------------------------------------
#------------------- oracle parameter ใช้ : -------------------------------------------------
#----- หา พขร วิ่งงานในเดือน จาก lh)dn ------------------------------------
qryDNEmpInMonth: select l.emp_no,e.name||' '||e.surname as driver
    ,COUNT(DISTINCT L.DN_NO) as num_dn,e.social_no
    from lh_dn l
    INNER JOIN LINE_LH_CAR_REGIS LC ON LC.STATUS='N' AND LC.CAR_REGIS=L.CAR_REGIS_NO AND LC.CUSTOMER_NO='LTC'
    inner join employee e on e.emp_no=l.emp_no
    where l.dn_date between
    (select trunc(last_day(add_months(to_date(({{date_of_work}}),'dd/mm/rrrr'),-1))+1) from dual)
    and (select trunc(last_day(to_date(({{date_of_work}}),'dd/mm/rrrr')) )  from dual)
    GROUP BY l.emp_no,e.name||' '||e.surname,e.social_no
    order by l.emp_no
#------------------------------------------------------------------------------------------
qryDnBetweenDay: select  l.emp_no,e.name||' '||e.surname as driver
    ,COUNT(DISTINCT L.DN_NO),e.social_no
    from lh_dn l
    INNER JOIN LINE_LH_CAR_REGIS LC ON LC.STATUS='N' AND LC.CAR_REGIS=L.CAR_REGIS_NO AND LC.CUSTOMER_NO='LTC'
    inner join employee e on e.emp_no=l.emp_no
    where l.dn_date between to_date(:begin_date,'dd/mm/yyyy') and to_date(:end_date,'dd/mm/yyyy')
    GROUP BY l.emp_no,e.name||' '||e.surname,e.social_no
    order by l.emp_no
#------------------------------------------------------------------------------------------
qryAllDNinMonth: select  to_char(t.dn_date,'mm/yyyy') as mmyy,t.dn_no,t.truck_no,t.ton_km_amt,t.fuel_quan
    ,case when t.engine_type = 'N' then 'ก.ก.' else 'ลิตร' end as fuel_unit
    from tmp_new_payment t
    where t.dn_order='99'
    and t.dn_date between  trunc(last_day(add_months(t.dn_date,-1))+1) and  trunc(last_day(t.dn_date))
    order by t.shipment,t.new_old
#------------------------------------------------------------------------------------------
qryDNperDayByEmp: select  to_char(t.dn_date,'mm/yyyy') as mmyy,t.dn_no,t.truck_no,t.ton_km_amt,t.fuel_quan
    from tmp_new_payment t
    where t.dn_order='99'
    and t.dn_date between  trunc(last_day(add_months(t.dn_date,-1))+1) and  trunc(last_day(t.dn_date))
    order by t.shipment,t.new_old
#------------------------------------------------------------------------------------------
GetEmpWorksBetweenDate:  with emp as (
    select l.emp_no,e.social_no as id_card,e.name||' '||e.surname as driver
    ,case when l.dn_rtn is null then count(distinct l.dn_no)  else 0 end as FH
    ,case when l.dn_rtn is not null then  count(distinct l.dn_no)  else 0 end as BH
    from lh_dn l
    inner join line_lh_car_regis lc on lc.status='N' and  lc.car_regis=l.car_regis_no and lc.customer_no='LTC'
    inner join employee e on e.emp_no=l.emp_no
    where l.dn_date between to_date(:begin_date,'dd/mm/yyyy') and to_date(:end_date,'dd/mm/yyyy')
    group by l.dn_rtn,l.emp_no,e.social_no  ,e.name||' '||e.surname
    )
    select emp.emp_no,emp.id_card,emp.driver ,sum(emp.fh) as fh,sum(emp.bh) as bh
    from emp
    group by emp.emp_no,emp.id_card,emp.driver
#---------------------------------------------------------------------------------------------------
qryChkDNError: with dn_error as (
    select distinct l.dn_no
    ,tonkm_package.find_dn_chain(l.dn_no) as dn_chain
    ,(select count(*) from lh_dn l2 where l2.dn_rtn=l.dn_no) as error_count
    ,l.emp_no,e.name|| ' '||e.surname as driver
    from lh_dn l
    inner join line_lh_car_regis lc on lc.status='N' and  lc.car_regis=l.car_regis_no and lc.customer_no='LTC'
    inner join employee e on e.emp_no=l.emp_no
    where l.dn_date between to_date('{{begin_date}}','dd/mm/rrrr') and to_date('{{end_date}}','dd/mm/rrrr')
    and instr(tonkm_package.find_dn_chain(l.dn_no),'rror')>0
    )
    select dn_error.dn_no
    ,(select distinct t.truck_no from truck t where t.truck_register_no=l.car_regis_no) as truck_no
    ,dn_error.emp_no,dn_error.driver
    ,dn_error.dn_chain as error,dn_error.error_count,l.dn_no as bh_dn,'อ้างอิง dn '||dn_error.dn_no||' ก่อนหน้าผิด'  as remark
    from dn_error
    join lh_dn l on l.dn_rtn = dn_error.dn_no

    union all

    select distinct l.dn_no
    ,(select distinct t.truck_no from truck t where t.truck_register_no=l.car_regis_no) as truck_no
    ,l.emp_no,e.name|| ' '||e.surname as driver
    ,'error อ้างอิงตัวเอง',1,l.dn_rtn,l.dn_no||' อ้างอิงตัวเอง'
    from lh_dn l
    inner join employee e on e.emp_no=l.emp_no
    where l.dn_date between to_date('{{begin_date}}','dd/mm/rrrr') and to_date('{{end_date}}','dd/mm/rrrr')
    and l.dn_no=l.dn_rtn

    union all

    select distinct l.dn_no
    ,(select distinct t.truck_no from truck t where t.truck_register_no=l.car_regis_no) as truck_no
    ,l.emp_no,e.name|| ' '||e.surname as driver
    ,'error อ้างอิงมากเกิน',1,l.dn_no,tonkm_package.find_dn_chain(l.dn_no)
    from lh_dn l
    inner join employee e on e.emp_no=l.emp_no
    where l.dn_date between to_date('{{begin_date}}','dd/mm/rrrr') and to_date('{{end_date}}','dd/mm/rrrr')
    and length(tonkm_package.find_dn_chain(l.dn_no))>60
    union all
    select distinct l.dn_no,lc.truck_no
    ,l.emp_no,e.name|| ' '||e.surname as driver
    ,'error',0,tonkm_package.find_dn_chain(l.dn_no),'error FH ไม่มีจุดจอด HUB'
    from lh_dn l
    INNER JOIN LINE_LH_CAR_REGIS LC ON LC.STATUS='N' AND LC.CAR_REGIS = L.CAR_REGIS_NO AND LC.CUSTOMER_NO='LTC'   --เฉพาะรถ LINE เท่านั้น
    inner join employee e on e.emp_no=l.emp_no
    where l.dn_date between to_date('{{begin_date}}','dd/mm/rrrr') and to_date('{{end_date}}','dd/mm/rrrr')
    and l.dn_rtn is null ---
    and not exists (select  1 from lh_dn_start_stop ls where ls.dn_no = l.dn_no)

    union all

    select DISTINCT
    l.dn_no,lc.truck_no,l.emp_no,e.name||' '||e.surname as driver,'NO ADD',1,L.DN_NO,'งาน '||l.customer_no||' '||'ไม่ระบุปลายทาง'
    from lh_dn l
    inner join request r on r.job_no=l.job_no
    inner join employee e on e.emp_no=l.emp_no
    join line_lh_car_regis lc on lc.status='N' and lc.car_regis=l.car_regis_no and lc.customer_no='LTC'
    where l.dn_date between  to_date('{{begin_date}}','dd/mm/rrrr') and to_date('{{end_date}}','dd/mm/rrrr')
    and (r.source_point = 'NOAD' OR R.RECEIVER='NOAD')

    union all

    select d.dn_no,d.truck_no,d.driver_no,e.name|| ' '||e.surname as driver,'Error ระยะทาง 0',1,d.dn_no,d.source_point||' - '||d.receiver as remark
    from dn_distance d
    inner join employee e on e.emp_no=d.driver_no
    where d.dn_date between to_date('{{begin_date}}','dd/mm/rrrr') and to_date('{{end_date}}','dd/mm/rrrr')
    AND D.SOURCE_POINT <> D.RECEIVER
    and d.distance=0
#---------------------------------------------------------------------------------------------------
qryAllowanceByEmp1: select  e.emp_no,e.name||' '||e.surname as driver ,e.tel,e.social_no
    ,count(distinct t.dn_no)
    ,sum(case when t.dn_type in ('F','B') and t.dn_order<>'99' then km_adj else 0 end) as KM_ADJ_LOAD
    ,sum(case when t.dn_type not in ('F','B') and t.dn_order<>'99' then km_adj else 0 end) as KM_ADJ_NOLOAD
    ,sum(case when t.dn_order='99' then t.ton_km_amt else 0 end) as ton_km_amt
    ,sum(case when t.dn_order='99' and t.engine_type ='N' then t.fuel_quan else 0 end) as FUEL_NGV
    ,sum(case when t.dn_order='99' and t.engine_type <> 'N' then t.fuel_quan else 0 end) as FUEL_DIESEL
    ,sum(case when t.dn_order='99' then t.multidrop else 0 end) as multidrop
    ,sum(case when t.dn_order = '99' then t.difficulty else 0 end ) as difficulty
    from tmp_new_payment t
    inner join employee e on e.emp_no=t.emp_no
    where t.dn_date between to_date(:begin_date,'dd/mm/rrrr') and to_date(:end_date,'dd/mm/rrrr')
    GROUP BY e.emp_no,e.name||' '||e.surname ,E.TEL,e.social_no
#---------------------------------------------------------------------------------------------------
qryAllowanceByEmp2: select t.dn_no         --0
    ,to_char(t.dn_date,'dd/mm/yyyy') as dn_date  --1
    ,t.truck_no  --2
    ,tonkm_package.engine_type(t.engine_type) as engine_type  --3
    ,TONKM_PACKAGE.find_multidrop_name(T.DN_NO) as multidrop_place  --4
    ,t.ton_km_amt  --5
    ,(case when t.engine_type ='N' then t.fuel_quan else 0 end) as fuel_ngv --6
    ,(case when t.engine_type <>'N' then t.fuel_quan else 0 end) as fuel_diesel  --7
    ,t.multidrop  --8
    ,t.difficulty  --9
    ,nvl((select sum(lg.gas_quan) from advance_lh a inner join lh_gas lg on lg.adv_no=a.adv_no
            and lg.gas_type<>'E' where a.dn_no=t.dn_no),0) as fuel_used
    from tmp_new_payment t
    where t.dn_date between to_date(:begin_date,'dd/mm/rrrr') and to_date(:end_date,'dd/mm/rrrr')
    and t.dn_order='99'
    order by t.shipment,t.dn_no,t.dn_order
#---------------------------------------------------------------------------------------------------
qryAllowanceByEmp3: select t.dn_order
    ,nvl(t.product_desc,'-') as product
    ,t.source_point
    ,t.receiver
    ,t.weight,t.km_adj,t.ton_km_amt,t.fuel_quan
    ,case when t.engine_type ='N' then 'ก.ก.' else 'ลิตร' end as fuel_unit
    ,t.multidrop,t.difficulty
    ,t.trans_remark
    ,t.remark
    ,(case when (t.source_point <> t.receiver) and t.distance=0 then 'adj_distance' else '-' end) adj_distance
    from tmp_new_payment t
    where t.dn_date between to_date(:begin_date,'dd/mm/rrrr') and to_date(:end_date,'dd/mm/rrrr')
    and t.dn_no='{{dn_no}}' and t.dn_order <>'99'
    order by t.shipment,t.dn_no,t.dn_order
#---------------------------------------------------------------------------------------------------
qryFuelUsed:   SELECT SUM(X.NGV_USED) AS NGV_USED ,SUM(X.DIESEL_USED) AS DIESEL_USED
    FROM (
        SELECT
        CASE WHEN T.ENGINE_TYPE='N' THEN
           NVL(sum(lg.gas_quan),0)
        ELSE 0
        END AS NGV_USED
        ,CASE WHEN T.ENGINE_TYPE<>'N' THEN
           NVL(sum(lg.gas_quan),0)
        ELSE 0
        END AS DIESEL_USED
        FROM TMP_NEW_PAYMENT T
        left outer join advance_lh a on a.dn_no=t.dn_no
        left outer join lh_gas lg on lg.adv_no=a.adv_no and lg.gas_type<>'E'
        where t.dn_date between to_date(:begin_date,'dd/mm/rrrr') and to_date(:end_date,'dd/mm/rrrr')
        and t.dn_order='99'
        GROUP BY T.ENGINE_TYPE
    ) X
#---------------------------------------------------------------------------------------------------
qryAllTonKM: select x.dn_order,x.truck_no,x.emp_no ,e.name||' '||e.surname as driver_name
    ,to_char(x.dn_date,'dd/mm/yyyy') as dn_date
    ,X.DN_NO
    ,x.product_desc as product
    ,x.source_point,x.receiver
    ,x.weight,x.distance,x.km_adj,x.ton_km_amt
    ,TONKM_PACKAGE.engine_type(x.engine_type) AS ENGINE_TYPE
    ,x.fuel_rate
    ,x.fuel_quan
    ,x.multidrop
    ,x.difficulty
    ,x.trans_remark
    ,x.remark
    from tmp_new_payment x
    inner join employee e on e.emp_no=x.emp_no
    order by x.emp_no,x.shipment,x.dn_no,x.dn_order
#---------------------------------------------------------------------------------------------------
qryDNperDay: select t.dn_no,t.ton_km_amt,t.fuel_quan,t.engine_type
      ,case when engine_type = 'N' then 'ก.ก.' else 'ลิตร' end as fuel_unit
      ,truck_no
      ,tonkm_package.find_multidrop_name(dn_no)
      ,trim(tonkm_package.find_multidrop_point(dn_no))
      ,(select sum(km_adj) from tmp_new_payment t2 where t2.dn_no = t.dn_no and t2.dn_order <>'99'
      and t2.dn_type in ('F','B') ) as km_load
      ,(select sum(km_adj) from tmp_new_payment t2 where t2.dn_no = t.dn_no and t2.dn_order <>'99' and
      t2.dn_type not in ('F','B') ) as km_noload
      ,tonkm_package.find_multidrop_value(dn_no) , t.difficulty
      ,nvl((select sum(lg.gas_quan) from advance_lh a inner join lh_gas lg on lg.adv_no = a.adv_no and lg.gas_type<>'E' where a.dn_no=t.dn_no),0) as fuel_used
      ,(case when (select min(t2.distance) from tmp_new_payment t2 where t2.dn_no=t.dn_no and t2.dn_order<>'99' and t2.source_point<>t2.receiver) = 0
              then 'รอแก้ไขระยะทาง' else 'good' end ) as remark
      from tmp_new_payment t
     where dn_order = '99' and dn_date between  to_date(:begin_date ,'dd/mm/yyyy') and to_date(:end_date,'dd/mm/yyyy')
     order by shipment,dn_order
#---------------------------------------------------------------------------------------------------
qryEmpTimestamp: select x.emp_no,x.driver,x.truck_no
    ,(case when x.ENERGY_TYPE = 'H' then 'ดีเซลใหม่'
          when x.ENERGY_TYPE = 'N' then 'NGV'
          when x.ENERGY_TYPE = 'C' then 'ดีเซลเปลี่ยนเครื่อง'
          when  x.ENERGY_TYPE = 'F' then 'ดีเซลเก่า'
    end ) as ENERGY_TYPE
    ,x.job_no  ,x.dn_no,to_char(x.dn_date,'dd/mm/yyyy'),x.source_point,x.source_name,x.source_addr3,x.lat_lng,x.remark1,x.dn_type
    from (
        select
        d.shipment ,d.dn_order,d.EMP_NO,E.NAME||' '||E.SURNAME AS DRIVER
        ,d.truck_no,d.dn_no,d.source_point,C.CUSTOMER_NAME as source_name,C.ADDRESS3 as source_addr3
        ,(select l.source_lat||','||l.source_long from lh_distance l where l.source_point = d.source_point and l.receiver=d.receiver) as lat_lng
        ,d.dn_type
        ,(case when d.dn_order = 5 then 'จุดตั้งต้น'
              when d.dn_order = 10 then 'ขึ้นสินค้าขาขึ้น'
              when d.dn_order =15 then 'ส่งสินค้าขาขึ้น'
              when d.dn_order in ( 20,30,40,50,60,70,80) then 'ขึ้นสินค้าขาลง'||( (d.dn_order-20)/10+1)
              when d.dn_order in ( 25,35,45,55,65,75,85)  then 'ส่งสินค้าขาลง'||((d.dn_order - 25)/10+1)
         end) as remark1
        ,LC.ENERGY_TYPE
        from tmp_new_payment d
        INNER JOIN CUSTOMER C ON C.CUSTOMER_NO = d.SOURCE_POINT
        INNER JOIN EMPLOYEE E ON E.EMP_NO=d.emp_no
        INNER JOIN LINE_LH_CAR_REGIS LC ON LC.TRUCK_NO=D.TRUCK_NO AND LC.STATUS='N'

        union all

        select d.shipment,99,d.EMP_NO,E.NAME||' '||E.SURNAME AS DRIVER
        ,d.truck_no,d.dn_no,d.receiver,C.CUSTOMER_NAME as source_name,C.ADDRESS3 as source_addr3
        ,(select max(l.source_lat||','||l.source_long) from lh_distance l where l.source_point =d.receiver) as lat_lng
        ,d.dn_type,'กลับจุดจอด',LC.ENERGY_TYPE
        from tmp_new_payment d
        inner join lh_distance l on l.source_point=d.source_point and l.receiver=d.receiver
        INNER JOIN CUSTOMER C ON C.CUSTOMER_NO = d.receiver
        INNER JOIN EMPLOYEE E ON E.EMP_NO=d.emp_no
        INNER JOIN LINE_LH_CAR_REGIS LC ON LC.TRUCK_NO=D.TRUCK_NO AND LC.STATUS='N'
        where d.dn_type='E'
    ) x
    order by x.dn_no,x.dn_order
#---------------------------------------------------------------------------------------------------
qryForTimestamp: select x.emp_no,x.social_no,x.driver,x.truck_no
    ,(case when x.ENERGY_TYPE = 'H' then 'ดีเซลใหม่'
              when x.ENERGY_TYPE = 'N' then 'NGV'
              when x.ENERGY_TYPE = 'C' then 'ดีเซลเปลี่ยนเครื่อง'
             when  x.ENERGY_TYPE = 'F' then 'ดีเซลเก่า'
     end )as ENERGY_TYPE
     ,x.job_no  ,x.dn_no,x.dn_order, to_char(x.dn_date,'dd/mm/yyyy') as dn_date,x.source_point,x.source_name,x.source_addr3,x.lat_lng,x.remark1,x.dn_type
     ,x.ADDRESS1
    from (
        select
        d.shipment ,d.dn_order,d.EMP_NO,E.NAME||' '||E.SURNAME AS DRIVER,e.social_no
        ,d.truck_no
        ,tonkm_package.find_multidrop_job(d.dn_no) as job_no ,d.dn_no,d.dn_date
        ,d.source_point,C.CUSTOMER_NAME as source_name,C.ADDRESS3 as source_addr3
        ,case when d.source_point = d.receiver then
           (select max(l.source_lat||','||l.source_long) from lh_distance l where l.source_point=d.source_point)
         else
            (select l.source_lat||','||l.source_long from lh_distance l where l.source_point = d.source_point and l.receiver=d.receiver)
         end  as lat_lng
        ,d.dn_type
        ,case when d.dn_order = 5 then 'จุดตั้งต้น'
              when d.dn_order = 10 then 'ขึ้นสินค้าขาขึ้น'
              when d.dn_order =15 then 'ส่งสินค้าขาขึ้น'
              when d.dn_order in ( 20,30,40,50,60,70,80) then 'ขึ้นสินค้าขาลง'||( (d.dn_order-20)/10+1)
              when d.dn_order in ( 25,35,45,55,65,75,85)  then 'ส่งสินค้าขาลง'||((d.dn_order - 25)/10+1)
         end as remark1
         ,d.remark
        ,LC.ENERGY_TYPE,C.ADDRESS1
        from tmp_new_payment d
        INNER JOIN CUSTOMER C ON C.CUSTOMER_NO = d.SOURCE_POINT
        INNER JOIN EMPLOYEE E ON E.EMP_NO=d.emp_no
        INNER JOIN LINE_LH_CAR_REGIS LC ON LC.TRUCK_NO=D.TRUCK_NO AND LC.STATUS='N'
    union all
        select d.shipment,99,d.EMP_NO,E.NAME||' '||E.SURNAME AS DRIVER,e.social_no
        ,d.truck_no
        ,tonkm_package.find_multidrop_job(d.dn_no) as job_no,d.dn_no,d.dn_date
        ,d.receiver,C.CUSTOMER_NAME as source_name,C.ADDRESS3 as source_addr3
        ,(select max(l.source_lat||','||l.source_long) from lh_distance l where l.source_point =d.receiver) as lat_lng
        ,d.dn_type,'กลับจุดจอด',LC.ENERGY_TYPE,d.remark,C.ADDRESS1
        from tmp_new_payment d
        inner join lh_distance l on l.source_point=d.source_point and l.receiver=d.receiver
        INNER JOIN CUSTOMER C ON C.CUSTOMER_NO = d.receiver
        INNER JOIN EMPLOYEE E ON E.EMP_NO=d.emp_no
        INNER JOIN LINE_LH_CAR_REGIS LC ON LC.TRUCK_NO=D.TRUCK_NO AND LC.STATUS='N'
       where d.dn_type='E'
    ) x
    order by
    x.dn_no,x.dn_order
#---------------------------------------------------------------------------------------------------
qryEmpDnBetweenDate: select distinct to_char(l.dn_date,'dd/mm/yyyy') as dn_date
    ,l.dn_no,tonkm_package.find_multidrop_job(l.dn_no) as job_no
    ,(select max(r.source_point) from request r where r.job_no in (select job_no from lh_dn  l2 where l2.dn_no = l.dn_no)) as start_place
    ,tonkm_package.find_multidrop_name(l.dn_no) as destination_place
    from lh_dn l where l.dn_date between :begin_date and :end_date and l.emp_no = :emp_no
    order by l.dn_no desc
# ---------------------------------------------------------------------------------------------------
# ---------------------- postgres12 -----------------------------------------------------------------
# ins_dn_timestamp: insert into dn_timestamp(data) values('{{data}}'::jsonb)
ins_dn_timestamp: select ins_dn_timestamp('{{data}}'::jsonb)

find_dn_dhain:
    select substr( tonkm_package.find_dn_chain(:dn_no),-10) from dual

qry_in_out: with md5 as (
      select min(data->>'MD5') as md5 from dn_timestamp t where t.data->>'DN_NO' = '{{dn_no}}' and t.data->>'EMP_NO'='{{emp_no}}'
    )
    select 	d.data->>'MD5' as md5,(d.data->>'DN_ORDER')::int as dn_order,d.data->>'IN_OUT' as in_out
    from dn_timestamp d where d.data->>'MD5' = (select md5 from md5)
    order by d.id desc limit 1
#---------------------------------------------------------------------------------------------------
getDNTimeStamp: with dn as (
     select min(data->>'MD5') as md5 from dn_timestamp t where t.data->>'DN_NO' = '{{dn_no}}'
    )
    select d.data->'DN_NO' as dn_no,d.data->'TRUCK_NO' as truck_no,d.data->'EMP_NO' as emp_no
    ,d.data->'SOURCE_POINT' as source_point
    ,d.data->'LAT_LNG' as lat_lng
    ,d.data->'IN_OUT' as in_out
    ,d.data->'POSITION' as mobile_data
    ,d.data->'TRUCK_POSITION' as truck_data
    ,c.customer_name,c.address1
    from dn_timestamp d
    inner join customer c on c.customer_no = data->>'SOURCE_POINT'::text
    where d.data->>'MD5' = (select md5 from DN)
    order by d.data->>'DN_NO' ,(d.data->>'DN_ORDER')::int,d.data->>'IN_OUT'
#---------------------------------------------------------------------------------------------------
#----- ใช้ใน GetEmpPaymentLH.py----------------------------------------------------------------------
qryEmpPaymentLH: select
    pd.dn_no,
    pd.quotation_desc AS QUOTATION_DESC
    ,pd.dn_date,pd.car_regis_no
    ,nvl(pd.allowance,0) as allowance
    ,pd.amount
    ,PD.GAS_PER_TRIP,PD.GAS_SPECIAL
    ,pd.adjust_amount
    ,pd.adjust_remark
    ,PD.GAS_QUAN
    ,PD.GAS_OPERA
    ,(PD.GAS_QUAN - PD.GAS_OPERA) AS GAS_DIFF
    ,PD.GAS_PRICE
    ,(PD.DIESEL_QUAN-PD.DIESEL_OPERA) AS DIESEL_DIFF
    ,PD.DIESEL_QUAN
    ,PD.DIESEL_OPERA
    ,PD.DIESEL_PRICE
    ,PD.PAID_AMOUNT
    --,nvl((select a.allowance_amount from allowance_lh a where a.period = substr(p.work_date_end,7,4)||'/'||substr(p.work_date_end,4,2) and a.emp_no=pd.emp_no) ,0) as allowance_amount
    ,0 as allowance_amount
    ,PD.ENERGY_TYPE
    ,nvl(pd.lift,0) as lift,nvl(pd.difficulty,0) as difficulty,nvl(pd.multidrop,0) as multidrop
    from payment_lh p,payment_lh_dtl pd,EMPLOYEE E
    where p.payment_date = :payment_date
    and pd.emp_no = :emp_no
    and p.payment_date = pd.payment_date
    AND  PD.EMP_NO = E.EMP_NO
    order by pd.payment_date,pd.emp_no,pd.dn_date,pd.dn_no
#---------------------------------------------------------------------------------------------------
#----- ใช้ใน GetEmpPaymentLH.py----------------------------------------------------------------------
qryEmpFixTire: SELECT E.EMP_NO,E.NAME||' '||E.SURNAME,LD.AMOUNT_TIRE
    FROM LH_DRIVER LD
    inner join employee e on e.emp_no=ld.emp_no
    WHERE LD.EMP_NO= :emp_no
    AND to_date(:payment_date,'dd/mm/yyyy')  BETWEEN LD.DATE_IN AND LD.DATE_OUT
#---------------------------------------------------------------------------------------------------
qryTimestampByDate: with d as (
       select d.data->'EMP_NO',d. data->'DN_DATE' ,d.data->'DN_NO'
	   ,max(d.id) as id from dn_timestamp d
	   where data->>'DN_DATE' between %(begin_date)s and %(end_date)s
	   -- OLD DATE FORMATE DD/MM/YYYY
       -- where to_timestamp(data->>'DN_DATE', 'DD/MM/YYYY') ::timestamp
       --     between to_timestamp(%(begin_date)s,'DD/MM/YYYY')
       --     and to_timestamp(%(end_date)s,'DD/MM/YYYY' )
       group by d.data->'EMP_NO', d.data->'DN_DATE' ,d.data->'DN_NO'
    )
    select  dt2.data->'EMP_NO' as emp_no,e.driver,e.tel
    ,dt2.data->'DN_DATE' as dn_date,dt2.data->'DN_NO' as dn_no ,dt2.data->'SOURCE_POINT' as source_point
	,dt2.data->'DN_ORDER' as dn_order,dt2.data->'IN_OUT' AS i_o
    ,case when dt2.data->>'IN_OUT' = ('1')::text then 'เข้า' else 'ออก' end as in_out
    ,dt2.data->'POSITION'->'timestamp' as timestamp
    ,dt2.data->'POSITION'->'address' as address
    ,dt2.data->'POSITION'->'far_from'->'distance' as distance
    ,(dt2.data->'POSITION'->>'latitude')::text as latitude
    ,(dt2.data->'POSITION'->>'longitude')::text as longitude
    ,c.customer_name,c.address1
    from d
        inner join dn_timestamp dt2 on dt2.id=d.id
        inner join employee e on e.emp_no = dt2.data->>'EMP_NO'
        inner join customer c on c.customer_no = dt2.data->>'SOURCE_POINT'
    order by emp_no,dn_date,dn_no,dn_order,i_o
#---------------------------------------------------------------------------------------------------
qryTimestampByDate2: with t as (
    select distinct l.dn_no ,l.emp_no,l.dn_date ,e.driver ,e.tel,c.customer_name,c.address1
    ,(
        select d.id
        from dn_timestamp d where
        data->>'DN_NO'=l.dn_no
        and id = (select max(d2.id)
                from dn_timestamp d2 where d2.data->>'DN_NO' = d.data->>'DN_NO')
    ) as id
    from lh_dn l
    inner join employee e on e.emp_no = l.emp_no
    inner join line_lh_car_regis  lc on lc.car_regis  = l.car_regis_no  and lc.customer_no ='LTC' and lc.status ='N'
    inner join customer c on c.customer_no = l.customer_no
    where l.dn_date  between %(begin_date)s and %(end_date)s
    )
    select t.emp_no,t.driver,t.tel,to_char(t.dn_date,'dd/mm/yyyy') as dn_date ,t.dn_no as dn_no
    ,dt.data->>'SOURCE_POINT' as source_point
    ,case when dt.data->>'IN_OUT' = '1' then 'เข้า'
          when dt.data->>'IN_OUT' = '2' then 'ออก'
     else 'ไม่บันทึก' end  as in_out,dt
    .data->'POSITION'->>'timestamp' as timestamp
    ,dt.data->'POSITION'->>'address' as address,dt.data->'POSITION'->'far_from'->>'distance' as distance,dt.data->'POSITION'->>'latitude' as latitude
    ,dt.data->'POSITION'->>'longitude' as longitude,dt.data->'POSITION'->>'timestamp' as timestamp
    ,t.customer_name,t.address1
    from t
    left outer join dn_timestamp dt on dt.id = t.id
    order by to_timestamp(dt.data->'POSITION'->>'timestamp','DD/MM/TTTT HH24:MI:SS') desc,emp_no
#---------------------------------------------------------------------------------------------------
qryTimestampBetweenDate: with d as (
        select distinct d.data->'DN_DATE' as dn_date,d.data->'DN_NO' as dn_no
        from dn_timestamp d
        where d.data->>'DN_DATE' between %(begin_date)s and %(end_date)s
        --where to_timestamp(d.data->>'DN_DATE','DD/MM/YYYY') between to_timestamp(%(begin_date)s,'DD/MM/YYYY')
        --      and to_timestamp(%(end_date)s,'DD/MM/YYYY')
        --and d.data->>'EMP_NO'::text = %(emp_no)s::text
    )
    select d.* from d
    order by dn_date,dn_no;
#-----------------------------------------------------------------------------------------------------
busNowDtl: select distinct l.dn_no
    ,e.emp_no,e.name||' '||e.surname as emp_name ,e.tel
    from lh_dn l
    inner join employee e on e.emp_no=l.emp_no
    where l.dn_no =
      (select  max(l.dn_no) as dn_no
               from lh_dn l
                inner join truck t on t.truck_register_no=l.car_regis_no
                where t.truck_no = transport.line_lh_pacakge2.CONV_TRUCK_NO2(:truck_no)
      )
#-----------------------------------------------------------------------------------------------------
upd_dn_timestamp_status: update dn_timestamp set data =jsonb_set(data,'{STATUS}','"P"'::jsonb,false)
	where id = %(id)s
#-----------------------------------------------------------------------------------------------------
#                     EmpLHWeekly
#-----------------------------------------------------------------------------------------------------
weekly_sum: with w as (
        select to_char(ta.processdate,'dd/mm/yyyy') as processdate
            ,e.name||' '||e.surname as emp_name
            ,ta.emp_no,ta.prv_balance
            ,sum(tw.adv_gas_amount) as sum_fuel_cash
            ,sum(tw.gas_cash) as sum_bill_fuel
            ,sum(tw.adv_cash) as sum_adv_cash
            ,sum(tw.oth_amount) as sum_oth_amount
            ,sum(tw.net) as sum_net
            ,to_char(ta.processdate,'yyyy-mm-dd') as sorted_date
        from tmp_emp_lh_weekly_api ta
        inner join tmp_emp_lh_weekly tw on ta.processdate=tw.processdate and ta.emp_no=tw.emp_no
        inner join employee e on e.emp_no = ta.emp_no
        group by ta.processdate,e.name||' '||e.surname,ta.emp_no,ta.prv_balance
        order by ta.processdate desc
    )
    select w.processdate,w.emp_name,w.emp_no,w.prv_balance,w.sum_fuel_cash,w.sum_bill_fuel,w.sum_adv_cash,w.sum_oth_amount,w.sum_net
    ,w.sum_fuel_cash+w.sum_bill_fuel+sum_adv_cash+sum_oth_amount - w.prv_balance as sum_for_dn
    ,case when w.sum_net <0 then -1*w.sum_net else 0 end as weekly_amount
    from w
    order by w.sorted_date desc
#-----------------------------------------------------------------------------------------------------
weekly_detail: select to_char(tw.processdate,'dd/mm/rrrr') as processdate
    ,tw.type,tw.emp_name,tw.truck_no
    ,tw.dn_no,to_char(tw.dn_date,'dd/mm/yyyy') as dn_date,
    tw.emp_no,tw.adv_gas_amount,tw.gas_cash,tw.adv_cash,tw.oth_amount,tw.net
    from tmp_emp_lh_weekly tw
    where tw.processdate = to_date(:processdate,'dd/mm/yyyy') and tw.emp_no = :emp_no
    order by tw.type desc,tw.dn_no